#include "debugfont.h"

enum
{
    DEBUGFONT_TX_WIDTH  = 64,
    DEBUGFONT_TX_HEIGHT = 256
};

void debugfont_init(
    taa_texture2d tex2d)
{
    static unsigned char pixels[] =
        "                                   ##                           "
        "                                   ##    ###                    "
        "           ##    ##  ##   ## ##   ####  ## ##     ###      ##   "
        "          ####   ##  ##   ## ##  ##  ## ## ## #  ## ##     ##   "
        "          ####   ##  ##  ####### ##      ### ##  ## ##     ##   "
        "          ####            ## ##   ##        ##    ###           "
        "           ##             ## ##    ##      ##    ##             "
        "           ##             ## ##     ##    ##     ## ####        "
        "                         #######     ##  ## ###  ##  ##         "
        "           ##             ## ##  ##  ##  # ## ## ##  ##         "
        "           ##             ## ##   ####     ## ##  ### ##        "
        "                                   ##       ###                 "
        "                                   ##                           "
        "                                                                "
        "                                                                "
        "                                                                "
        "    ##    ##                                                 ## "
        "   ##      ##                                                ## "
        "   ##      ##     ## ##    ##                               ##  "
        "  ##        ##     ###     ##                               ##  "
        "  ##        ##   ####### ######          ######            ##   "
        "  ##        ##     ###     ##                              ##   "
        "  ##        ##    ## ##    ##                             ##    "
        "  ##        ##                     ###             ###    ##    "
        "   ##      ##                      ###             ###   ##     "
        "   ##      ##                       ##                   ##     "
        "    ##    ##                       ##                           "
        "                                                                "
        "                                                                "
        "                                                                "
        "   ####     ##    ####    ####    ##     ######    ###   ###### "
        "  ##  ##   ###   ##  ##  ##  ##   ##     ##        ##        ## "
        "  ## ### #####   ##  ##  ##  ##   ## ##  ##       ##        ##  "
        "  ## ###    ##       ##      ##   ## ##  ##      #####      ##  "
        "  ##  ##    ##      ##     ###    ## ##  #####   ##  ##    ##   "
        "  ### ##    ##     ##        ##  ##  ##      ##  ##  ##    ##   "
        "  ### ##    ##    ##     ##  ##  #######     ##  ##  ##   ##    "
        "  ##  ##    ##   ##      ##  ##      ##     ##   ##  ##   ##    "
        "   ####     ##   ######   ####       ##  ####     ####    ##    "
        "                                                                "
        "                                                                "
        "                                                                "
        "                                                                "
        "                                                                "
        "  ####    ####                       ##          ##       ####  "
        " ##  ##  ##  ##                     ##            ##     ##  ## "
        " ##  ##  ##  ##    ###     ###     ##              ##    ##  ## "
        " ### ##  ##  ##    ###     ###    ##     ######     ##      ##  "
        "  ####   ##  ##                  ##                  ##    ##   "
        " ## ###   #####                   ##     ######     ##     ##   "
        " ##  ##     ##                     ##              ##           "
        " ##  ##    ##      ###     ###      ##            ##       ##   "
        "  ####    ###      ###     ###       ##          ##        ##   "
        "                            ##                                  "
        "                           ##                                   "
        "                                                                "
        "                                                                "
        "                                                                "
        " ######    ##    #####    ####   ####    ######  ######   ####  "
        "##    ##  ####   ##  ##  ##  ##  ## ##   ##      ##      ##  ## "
        "##    ## ##  ##  ##  ##  ##  ##  ##  ##  ##      ##      ##  ## "
        "##  #### ##  ##  ##  ##  ##      ##  ##  ##      ##      ##     "
        "## ## ## ##  ##  #####   ##      ##  ##  #####   #####   ##     "
        "## ## ## ######  ##  ##  ##      ##  ##  ##      ##      ## ### "
        "##  #### ##  ##  ##  ##  ##  ##  ##  ##  ##      ##      ##  ## "
        "##       ##  ##  ##  ##  ##  ##  ## ##   ##      ##      ##  ## "
        " ####### ##  ##  #####    ####   ####    ######  ##       ##### "
        "                                                                "
        "                                                                "
        "                                                                "
        "                                                                "
        "                                                                "
        " ##  ##   ####       ##  ##  ##  ##      ##   ## ##   ##  ####  "
        " ##  ##    ##        ##  ##  ##  ##      ##   ## ##   ## ##  ## "
        " ##  ##    ##        ##  ## ##   ##      ### ### ###  ## ##  ## "
        " ##  ##    ##        ##  ## ##   ##      ## # ## #### ## ##  ## "
        " ######    ##        ##  ####    ##      ## # ## ## #### ##  ## "
        " ##  ##    ##        ##  ## ##   ##      ## # ## ##  ### ##  ## "
        " ##  ##    ##    ##  ##  ## ##   ##      ##   ## ##   ## ##  ## "
        " ##  ##    ##    ##  ##  ##  ##  ##      ##   ## ##   ## ##  ## "
        " ##  ##   ####    ####   ##  ##  ######  ##   ## ##   ##  ####  "
        "                                                                "
        "                                                                "
        "                                                                "
        "                                                                "
        "                                                                "
        " #####    ####   #####    ####   ######  ##  ##  ##  ##  ##   ##"
        " ##  ##  ##  ##  ##  ##  ##  ##    ##    ##  ##  ##  ##  ##   ##"
        " ##  ##  ##  ##  ##  ##  ##        ##    ##  ##  ##  ##  ##   ##"
        " ##  ##  ##  ##  ##  ##   ##       ##    ##  ##  ##  ##  ## # ##"
        " #####   ##  ##  #####     ##      ##    ##  ##  ##  ##  ## # ##"
        " ##      ##  ##  ## ##      ##     ##    ##  ##  ##  ##  ## # ##"
        " ##      ##  ##  ##  ##      ##    ##    ##  ##  ##  ##   ## ## "
        " ##      ##  ##  ##  ##  ##  ##    ##    ##  ##   ####    ## ## "
        " ##       ####   ##  ##   ####     ##     ####     ##     ## ## "
        "            ##                                                  "
        "             ##                                                 "
        "                                                                "
        "                                                   ##           "
        "                                                  ####          "
        " ##  ##  ##  ##  ######   ####   ##       ####   ##  ##         "
        " ##  ##  ##  ##      ##   ##     ##         ##                  "
        "  ## #   ##  ##      ##   ##      ##        ##                  "
        "   ##    ##  ##     ##    ##      ##        ##                  "
        "   ##     ####     ##     ##       ##       ##                  "
        "  # ##     ##     ##      ##       ##       ##                  "
        " ##  ##    ##    ##       ##        ##      ##                  "
        " ##  ##    ##    ##       ##        ##      ##                  "
        " ##  ##    ##    ######   ##         ##     ##                  "
        "                          ##         ##     ##                  "
        "                          ##                ##                  "
        "                          ####            ####          ########"
        "  ###                                                           "
        "   ##                                                           "
        "    ##           ##                  ##            ####         "
        "                 ##                  ##           ##            "
        "          ####   #####    ####    #####   ####    ##      ##### "
        "             ##  ##  ##  ##  ##  ##  ##  ##  ##   ##     ##  ## "
        "             ##  ##  ##  ##      ##  ##  ##  ##  ######  ##  ## "
        "          #####  ##  ##  ##      ##  ##  ######   ##     ##  ## "
        "         ##  ##  ##  ##  ##      ##  ##  ##       ##     ##  ## "
        "         ##  ##  ##  ##  ##  ##  ##  ##  ##       ##     ##  ## "
        "          #####  #####    ####    #####   ####    ##      ##### "
        "                                                             ## "
        "                                                             ## "
        "                                                         #####  "
        "                                                                "
        "           ##       ##                                          "
        " ##        ##       ##   ##      ####                           "
        " ##                      ##        ##                           "
        " #####   ####     ####   ##  ##    ##    ######  #####    ####  "
        " ##  ##    ##       ##   ##  ##    ##    ## # ## ##  ##  ##  ## "
        " ##  ##    ##       ##   ## ##     ##    ## # ## ##  ##  ##  ## "
        " ##  ##    ##       ##   ####      ##    ## # ## ##  ##  ##  ## "
        " ##  ##    ##       ##   ## ##     ##    ## # ## ##  ##  ##  ## "
        " ##  ##    ##       ##   ##  ##    ##    ## # ## ##  ##  ##  ## "
        " ##  ##  ######     ##   ##  ##  ######  ##   ## ##  ##   ####  "
        "                    ##                                          "
        "                    ##                                          "
        "                 ####                                           "
        "                                                                "
        "                                                                "
        "                                  ##                            "
        "                                  ##                            "
        " #####    #####  ##  ##   #####  ######  ##  ##  ##  ##  ##   ##"
        " ##  ##  ##  ##  ## ###  ##       ##     ##  ##  ##  ##  ## # ##"
        " ##  ##  ##  ##  ###     ##       ##     ##  ##  ##  ##  ## # ##"
        " ##  ##  ##  ##  ##       ####    ##     ##  ##  ##  ##  ## # ##"
        " ##  ##  ##  ##  ##          ##   ##     ##  ##  ##  ##  ## # ##"
        " ##  ##  ##  ##  ##          ##   ##     ##  ##   ####    ## ## "
        " #####    #####  ##      #####     ####   #####    ##     ## ## "
        " ##          ##                                                 "
        " ##          ##                                                 "
        " ##          ##                                                 "
        "                                                                "
        "                                                                "
        "                            ##     ##     ##     ###   #        "
        "                           ##      ##      ##   ## ## ##        "
        " ##  ##  ##  ##  ######    ##      ##      ##   #   ###         "
        " ##  ##  ##  ##      ##    ##      ##      ##                   "
        "  ####   ##  ##     ##    ##       ##       ##                  "
        "   ##    ##  ##    ##    ##        ##        ##                 "
        "  ####   ##  ##   ##      ##       ##       ##                  "
        " ##  ##  ##  ##  ##        ##      ##      ##                   "
        " ##  ##   ####   ######    ##      ##      ##                   "
        "            ##             ##      ##      ##                   "
        "           ##               ##     ##     ##                    "
        "        ####                       ##                           ";
    // fix pixel values to black and white
    unsigned char* pxitr = pixels;
    unsigned char* pxend = pxitr + sizeof(pixels);
    while(pxitr != pxend)
    {
        *pxitr = ((*pxitr) & 0x01) * 0xff;
        ++pxitr;
    }
    // chars are 8 x 14 pixels in 8 cols x 12 rows
    // texture is 64 x 168
    taa_texture2d_bind(tex2d);
    taa_texture2d_setparameter(taa_TEXPARAM_MAX_LEVEL, 0);
    taa_texture2d_setparameter(taa_TEXPARAM_MAG_FILTER,taa_TEXFILTER_NEAREST);
    taa_texture2d_setparameter(taa_TEXPARAM_MIN_FILTER,taa_TEXFILTER_NEAREST);
    taa_texture2d_setparameter(taa_TEXPARAM_WRAP_S,taa_TEXWRAP_CLAMP);
    taa_texture2d_setparameter(taa_TEXPARAM_WRAP_T,taa_TEXWRAP_CLAMP);
    taa_texture2d_image(0, taa_TEXFORMAT_ALPHA8, 64, 256, NULL);
    taa_texture2d_subimage(0, taa_TEXFORMAT_ALPHA8, 0, 0, 64, 168, pixels);
}

unsigned debugfont_gen_vertices(
    const char* str,
    unsigned vieww,
    unsigned viewh,
    int x,
    int y,
    unsigned color,
    debugfont_vert* verts_out,
    unsigned maxverts)
{
    debugfont_vert* vitr = verts_out;
    debugfont_vert* vend = vitr + maxverts;
    float pw = 2.0f/vieww;
    float ph = 2.0f/viewh;
    float cw = 8 * pw;
    float ch = 14 * ph;
    float cx = x * pw - 1.0f;
    float cy = y * -ph + 1.0f;
    float uw = DEBUGFONT_CHAR_WIDTH/64.0f;
    float vh = DEBUGFONT_CHAR_HEIGHT/256.0f;
    while(*str != '\0' && (vitr+6) < vend)
    {
        char chr = *str;
        unsigned char b = ((chr >= ' ' && chr <= '~') ? chr : ' ') - ' ';
        float x0 = cx;
        float y0 = cy;
        float x1 = cx + cw;
        float y1 = cy - ch;
        float u0 = ((b & (8-1))*DEBUGFONT_CHAR_WIDTH)/64.0f;
        float v0 = ((b / 8)*DEBUGFONT_CHAR_HEIGHT)/256.0f;
        float u1 = u0 + uw;
        float v1 = v0 + vh;
        vitr->pos[0] = x0;
        vitr->pos[1] = y0;
        vitr->uv[0] = u0;
        vitr->uv[1] = v0;
        vitr->color = color;
        ++vitr;
        vitr->pos[0] = x0;
        vitr->pos[1] = y1;
        vitr->uv[0] = u0;
        vitr->uv[1] = v1;
        vitr->color = color;
        ++vitr;
        vitr->pos[0] = x1;
        vitr->pos[1] = y0;
        vitr->uv[0] = u1;
        vitr->uv[1] = v0;
        vitr->color = color;
        ++vitr;
        vitr->pos[0] = x1;
        vitr->pos[1] = y0;
        vitr->uv[0] = u1;
        vitr->uv[1] = v0;
        vitr->color = color;
        ++vitr;
        vitr->pos[0] = x0;
        vitr->pos[1] = y1;
        vitr->uv[0] = u0;
        vitr->uv[1] = v1;
        vitr->color = color;
        ++vitr;
        vitr->pos[0] = x1;
        vitr->pos[1] = y1;
        vitr->uv[0] = u1;
        vitr->uv[1] = v1;
        vitr->color = color;
        ++vitr;
        cx = x1;
        ++str;
    }
    return (unsigned) (vitr - verts_out);
}
